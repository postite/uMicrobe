<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ da28365)
 * Haxe source file: /Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx
 */

namespace ufront\web\url\filter;

use \ufront\web\url\VirtualUrl;
use \php\Boot;
use \php\_Boot\HxString;
use \ufront\web\url\PartialUrl;

/**
 * A `UFUrlFilter` to add or remove a subdirectory that this app is located in on the web server.
 * For example if your app is stored in `/personal/blog/`, this would filter URLs between a normalized state for the app (`/posts/3/`) and the raw state of the webserver (`/personal/blog/posts/3/`)
 */
class DirectoryUrlFilter implements UFUrlFilter {
	/**
	 * @var string
	 * The directory that you wish to filter (usually, the path the app is running from relative to the web server root).
	 */
	public $directory;
	/**
	 * @var \Array_hx
	 */
	public $segments;


	/**
	 * Construct a new filter for the given directory
	 * 
	 * @param string $directory
	 * 
	 * @return void
	 */
	public function __construct ($directory) {
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:20: lines 20-21
		if (\StringTools::startsWith($directory, "/")) {
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:21: characters 4-55
			$directory = HxString::substr($directory, 1, strlen($directory));
		}
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:22: lines 22-23
		if (\StringTools::endsWith($directory, "/")) {
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:23: characters 4-57
			$directory = HxString::substr($directory, 0, strlen($directory) - 1);
		}
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:24: characters 3-29
		$this->directory = $directory;
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:25: characters 3-64
		$this->segments = ($directory !== "" ? \Array_hx::wrap(explode("/", $directory)) : new \Array_hx());
	}


	/**
	 * Remove the subdirectory from a `PartialUrl`
	 * 
	 * @param PartialUrl $url
	 * 
	 * @return void
	 */
	public function filterIn ($url) {
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:30: characters 3-15
		$pos = 0;
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: lines 31-32
		while (true) {
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: characters 11-68
			$tmp = null;
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: characters 11-68
			if ($url->segments->length > 0) {
				#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: characters 62-67
				$pos = $pos + 1;
				#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: characters 11-68
				$tmp = ($url->segments->arr[0] ?? null) === ($this->segments->arr[$pos - 1] ?? null);
			} else {
				#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: characters 11-68
				$tmp = false;
			}
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: lines 31-32
			if (!$tmp) {
				#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:31: lines 31-32
				break;
			}
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:32: characters 4-24
			$_this = $url->segments;
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:32: characters 4-24
			if ($_this->length > 0) {
				#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:32: characters 4-24
				$_this->length--;
			}
			#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:32: characters 4-24
			array_shift($_this->arr);
		}
	}


	/**
	 * Add the subdirectory to a `VirtualUrl`
	 * 
	 * @param VirtualUrl $url
	 * 
	 * @return void
	 */
	public function filterOut ($url) {
		#/Users/ut/Documents/LAB/ufront-mvc/src/ufront/web/url/filter/DirectoryUrlFilter.hx:37: characters 3-49
		$url->segments = $this->segments->concat($url->segments);
	}
}


Boot::registerClass(DirectoryUrlFilter::class, 'ufront.web.url.filter.DirectoryUrlFilter');
