<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ da28365)
 * Haxe source file: /usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx
 */

namespace haxe;

use \php\Boot;
use \php\_Boot\HxString;

class CallStack {
	/**
	 * @var mixed
	 */
	static public $lastExceptionTrace;
	/**
	 * @var \Closure
	 * If defined this function will be used to transform call stack entries.
	 * @param String - generated php file name.
	 * @param Int - Line number in generated file.
	 */
	static public $mapPosition;


	/**
	 * Return the call stack elements, or an empty array if not available.
	 * 
	 * @return \Array_hx
	 */
	static public function callStack () {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:33: characters 3-78
		return CallStack::makeStack(debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS));
	}


	/**
	 * Return the exception stack : this is the stack elements between
	 * the place the last exception was thrown and the place it was
	 * caught, or an empty array if not available.
	 * 
	 * @return \Array_hx
	 */
	static public function exceptionStack () {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 20-94
		$tmp = null;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 20-94
		if (CallStack::$lastExceptionTrace === null) {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 49-73
			$this1 = [];
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 20-94
			$tmp = $this1;
		} else {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 20-94
			$tmp = CallStack::$lastExceptionTrace;
		}
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:42: characters 3-95
		return CallStack::makeStack($tmp);
	}


	/**
	 * @param \StringBuf $b
	 * @param StackItem $s
	 * 
	 * @return void
	 */
	static public function itemToString ($b, $s) {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:58: lines 58-79
		switch ($s->index) {
			case 0:
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:60: characters 5-26
				$b->add("a C function");
				break;
			case 1:
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:61: characters 16-17
				$m = $s->params[0];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:62: characters 5-21
				$b->add("module ");
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:63: characters 5-13
				$b->add($m);

				break;
			case 2:
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:64: characters 24-28
				$line = $s->params[2];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:64: characters 19-23
				$file = $s->params[1];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:64: characters 17-18
				$s1 = $s->params[0];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:65: lines 65-68
				if ($s1 !== null) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:66: characters 6-23
					CallStack::itemToString($b, $s1);
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:67: characters 6-17
					$b->add(" (");
				}
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:69: characters 5-16
				$b->add($file);
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:70: characters 5-20
				$b->add(" line ");
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:71: characters 5-16
				$b->add($line);
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:72: characters 5-31
				if ($s1 !== null) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:72: characters 21-31
					$b->add(")");
				}

				break;
			case 3:
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:73: characters 22-26
				$meth = $s->params[1];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:73: characters 16-21
				$cname = $s->params[0];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:74: characters 5-17
				$b->add($cname);
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:75: characters 5-15
				$b->add(".");
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:76: characters 5-16
				$b->add($meth);

				break;
			case 4:
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:77: characters 23-24
				$n = $s->params[0];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:78: characters 5-28
				$b->add("local function");
				break;
		}
	}


	/**
	 * @param mixed $native
	 * 
	 * @return \Array_hx
	 */
	static public function makeStack ($native) {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:118: characters 3-19
		$result = new \Array_hx();
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:119: characters 3-36
		$count = count($native);
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:121: lines 121-150
		$_g1 = 0;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:121: lines 121-150
		$_g = $count;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:121: lines 121-150
		while ($_g1 < $_g) {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:121: lines 121-150
			$_g1 = $_g1 + 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:121: characters 8-9
			$i = $_g1 - 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:122: characters 4-26
			$entry = $native[$i];
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:123: characters 4-20
			$item = null;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:125: lines 125-137
			if (($i + 1) < $count) {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:126: characters 5-30
				$next = $native[$i + 1];
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:128: characters 5-62
				if (!isset($next["function"])) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:128: characters 41-62
					$next["function"] = "";
				}
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:129: characters 5-56
				if (!isset($next["class"])) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:129: characters 38-56
					$next["class"] = "";
				}
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:131: lines 131-136
				if (HxString::indexOf($next["function"], "{closure}") >= 0) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:132: characters 6-28
					$item = StackItem::LocalFunction();
				} else if ((strlen($next["class"]) > 0) && (strlen($next["function"]) > 0)) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:134: characters 6-49
					$cls = Boot::getClassName($next["class"]);
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:135: characters 6-42
					$item = StackItem::Method($cls, $next["function"]);
				}
			}
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:138: lines 138-149
			if (isset($entry["file"])) {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:139: lines 139-145
				if (CallStack::$mapPosition !== null) {
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:140: characters 6-58
					$pos = (CallStack::$mapPosition)($entry["file"], $entry["line"]);
					#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:141: lines 141-144
					if (($pos !== null) && ($pos->source !== null) && ($pos->originalLine !== null)) {
						#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:142: characters 7-33
						$entry["file"] = $pos->source;
						#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:143: characters 7-39
						$entry["line"] = $pos->originalLine;
					}
				}
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:146: characters 5-61
				$result->arr[$result->length] = StackItem::FilePos($item, $entry["file"], $entry["line"]);
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:146: characters 5-61
				++$result->length;

			} else if ($item !== null) {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:148: characters 5-22
				$result->arr[$result->length] = $item;
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:148: characters 5-22
				++$result->length;
			}
		}

		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:152: characters 3-16
		return $result;
	}


	/**
	 * @param \Throwable $e
	 * 
	 * @return void
	 */
	static public function saveExceptionTrace ($e) {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:84: characters 3-36
		CallStack::$lastExceptionTrace = $e->getTrace();
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:87: characters 3-80
		$currentTrace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:88: characters 3-42
		$count = count($currentTrace);
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:90: lines 90-100
		$_g = -($count - 1);
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:90: lines 90-100
		while ($_g < 1) {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:90: lines 90-100
			$_g = $_g + 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:90: characters 8-9
			$i = $_g - 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:91: characters 4-82
			$exceptionEntry = end(CallStack::$lastExceptionTrace);
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:93: lines 93-99
			if (!isset($exceptionEntry["file"]) || !isset($currentTrace[-$i]["file"])) {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:94: characters 5-41
				array_pop(CallStack::$lastExceptionTrace);
			} else if (Boot::equal($currentTrace[-$i]["file"], $exceptionEntry["file"]) && Boot::equal($currentTrace[-$i]["line"], $exceptionEntry["line"])) {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:96: characters 5-41
				array_pop(CallStack::$lastExceptionTrace);
			} else {
				#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:98: characters 5-10
				break;
			}
		}

		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:103: characters 3-48
		$count1 = count(CallStack::$lastExceptionTrace);
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:104: lines 104-106
		$_g1 = 0;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:104: lines 104-106
		$_g2 = $count1;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:104: lines 104-106
		while ($_g1 < $_g2) {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:104: lines 104-106
			$_g1 = $_g1 + 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:104: characters 8-9
			$i1 = $_g1 - 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:105: characters 4-53
			$this1 = CallStack::$lastExceptionTrace[$i1];
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:105: characters 36-53
			$this2 = [];
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:105: characters 4-53
			$this1["args"] = $this2;

		}

		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:108: characters 18-49
		$this3 = [];
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:108: characters 3-50
		$thrownAt = $this3;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:109: characters 3-28
		$thrownAt["function"] = "";
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:110: characters 3-33
		$thrownAt["line"] = $e->getLine();
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:111: characters 3-33
		$thrownAt["file"] = $e->getFile();
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:112: characters 3-25
		$thrownAt["class"] = "";
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:113: characters 22-39
		$this4 = [];
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:113: characters 3-39
		$thrownAt["args"] = $this4;

		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:114: characters 3-53
		array_unshift(CallStack::$lastExceptionTrace, $thrownAt);
	}


	/**
	 * Returns a representation of the stack as a printable string.
	 * 
	 * @param \Array_hx $stack
	 * 
	 * @return string
	 */
	static public function toString ($stack) {
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:49: characters 3-27
		$b = new \StringBuf();
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:50: lines 50-53
		$_g = 0;
		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:50: lines 50-53
		while ($_g < $stack->length) {
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:50: characters 8-9
			$s = ($stack->arr[$_g] ?? null);
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:50: lines 50-53
			$_g = $_g + 1;
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:51: characters 4-27
			$b->add("\x0ACalled from ");
			#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:52: characters 4-21
			CallStack::itemToString($b, $s);
		}

		#/usr/local/lib/haxe/std/php/_std/haxe/CallStack.hx:54: characters 3-22
		return $b->b;
	}
}


Boot::registerClass(CallStack::class, 'haxe.CallStack');
