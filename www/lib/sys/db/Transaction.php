<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ da28365)
 * Haxe source file: /usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx
 */

namespace sys\db;

use \php\_Boot\HxException;
use \php\Boot;
use \haxe\CallStack;

class Transaction {
	/**
	 * @param mixed $e
	 * 
	 * @return bool
	 */
	static public function isDeadlock ($e) {
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:27: characters 10-68
		if (Boot::is($e, Boot::getClass('String'))) {
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:27: characters 30-68
			return (new \EReg("try restarting transaction", ""))->match($e);
		} else {
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:27: characters 10-68
			return false;
		}
	}


	/**
	 * @param Connection $cnx
	 * @param \Closure $mainFun
	 * @param \Closure $logError
	 * 
	 * @return void
	 */
	static public function main ($cnx, $mainFun, $logError = null) {
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:54: characters 3-23
		Manager::initialize();
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:55: characters 3-20
		Manager::set_cnx($cnx);
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:56: characters 3-33
		Manager::$cnx->startTransaction();
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:57: characters 3-34
		Transaction::runMainLoop($mainFun, $logError, 3);
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:58: lines 58-64
		try {
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:59: characters 4-24
			Manager::$cnx->commit();
		} catch (\Throwable $__hx__caught_e) {
			CallStack::saveExceptionTrace($__hx__caught_e);
			$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
			if (is_string($__hx__real_e)) {
				$e = $__hx__real_e;
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:62: lines 62-63
				if ((new \EReg("Database is busy", ""))->match($e)) {
					#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:63: characters 5-16
					$logError($e);
				}
			} else  throw $__hx__caught_e;
		}
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:65: characters 3-22
		Manager::$cnx->close();
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:66: characters 3-21
		Manager::set_cnx(null);
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:67: characters 3-20
		Manager::cleanup();
	}


	/**
	 * @param \Closure $mainFun
	 * @param \Closure $logError
	 * @param int $count
	 * 
	 * @return void
	 */
	static public function runMainLoop ($mainFun, $logError, $count) {
		#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:31: lines 31-50
		try {
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:32: characters 4-13
			$mainFun();
		} catch (\Throwable $__hx__caught_e) {
			CallStack::saveExceptionTrace($__hx__caught_e);
			$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
			$e = $__hx__real_e;
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:34: lines 34-40
			if (($count > 0) && Transaction::isDeadlock($e)) {
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:35: characters 5-22
				Manager::cleanup();
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:36: characters 5-27
				Manager::$cnx->rollback();
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:37: characters 5-35
				Manager::$cnx->startTransaction();
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:38: characters 5-42
				Transaction::runMainLoop($mainFun, $logError, $count - 1);
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:39: characters 5-11
				return;
			}
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:41: lines 41-48
			if ($logError === null) {
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:42: characters 5-27
				Manager::$cnx->rollback();
				#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:46: characters 5-10
				throw (is_object($__hx__throw = $e) && $__hx__throw instanceof \Throwable ? $__hx__throw : new HxException($__hx__throw));
			}
			#/usr/local/lib/haxe/lib/record-macros/git/src/sys/db/Transaction.hx:49: characters 4-15
			$logError($e);
		}
	}
}


Boot::registerClass(Transaction::class, 'sys.db.Transaction');
